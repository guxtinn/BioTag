{% extends "core/base.html" %}
{% load static %}

{% block title %}BioTag - Scanner QR Code{% endblock %}

{% block main_content %}
<div class="row justify-content-center animated-content">
    <div class="col-lg-6 col-md-8 col-12">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
            <h1 class="fw-bold" style="color: var(--if-green);"><i class="bi bi-camera"></i> Escanear QR Code</h1>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>

        <div class="card card-shadow p-4 text-center">
            <p class="text-muted">Aponte a câmera para o QR Code da Tag.</p>
            
            <div id="reader" class="overflow-hidden" style="width: 100%; border: 2px solid var(--if-green); border-radius: 12px; background: #eee;"></div>
            
            <div id="result" class="mt-3 alert alert-warning" style="display: none;">
                Escaneando...
            </div>
            
            <div id="camera-auth-warning" class="mt-3">
                <p class="small text-danger">Se a câmera não abrir, verifique as permissões do navegador no ícone de cadeado acima.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
    function onScanSuccess(decodedText) {
        // Para o scanner
        html5qrcode.stop().then(() => {
            let resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'mt-3 alert alert-success';
            resultDiv.innerHTML = "QR Code identificado! Redirecionando...";

            // Extração inteligente do ID
            let parts = decodedText.split('/');
            let tagId = parts[parts.length - 1] || parts[parts.length - 2];
            
            window.location.href = `/consulta/${tagId}/`;
        }).catch(err => {
            console.error("Erro ao parar câmera", err);
            window.location.href = decodedText; // Tenta ir direto
        });
    }

    // Configuração avançada para Mobile
    const html5qrcode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    // Inicia a câmera automaticamente tentando a traseira (environment)
    html5qrcode.start(
        { facingMode: "environment" }, 
        config, 
        onScanSuccess
    ).catch(err => {
        console.error("Erro ao iniciar câmera:", err);
        document.getElementById('camera-auth-warning').innerHTML = 
            `<button class="btn btn-success" onclick="location.reload()">Ativar Câmera</button>`;
    });
</script>
{% endblock %}